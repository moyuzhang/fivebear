# WebSocket 实时通知功能测试指南

## 功能概述

实现了WebSocket实时通知功能，用于在多地登录时实时通知用户。当用户在其他设备登录时，当前会话会收到强制下线通知。

## 技术实现

### 后端实现
1. **WebSocket配置** (`WebSocketConfig.java`)
   - 启用WebSocket支持
   - 配置SockJS回退
   - 允许跨域连接

2. **WebSocket处理器** (`LoginNotificationHandler.java`)
   - 处理WebSocket连接和认证
   - 维护用户会话映射
   - 发送强制下线通知

3. **集成认证服务** (`AuthServiceImpl.java`)
   - 在登录时通过WebSocket通知其他会话
   - 实现强制下线逻辑

### 前端实现
1. **WebSocket服务** (`utils/websocket.ts`)
   - SockJS客户端连接
   - 自动重连机制
   - 消息处理和错误处理

2. **状态指示器** (`WebSocketStatus.vue`)
   - 实时显示连接状态
   - 绿色：已连接，红色：未连接

3. **用户Store集成** (`stores/user.ts`)
   - 登录时建立WebSocket连接
   - 登出时断开连接

## 测试步骤

### 准备工作
1. 启动后端服务：
   ```bash
   cd backend
   mvn spring-boot:run
   ```

2. 启动前端服务：
   ```bash
   cd frontend
   npm run dev
   ```

3. 确保Redis服务运行

### 测试流程

#### 1. 单用户登录测试
1. 打开浏览器访问 `http://localhost:3001`
2. 使用管理员账户登录：`admin/Aa147258`
3. 观察右上角WebSocket状态指示器
   - 应显示绿色圆点（已连接）
   - 鼠标悬停显示"实时通知已连接"

#### 2. 多地登录强制下线测试
1. **第一个会话**：
   - 浏览器A登录系统
   - 进入任意页面（如Dashboard）
   - 确认WebSocket状态为绿色

2. **第二个会话**：
   - 打开隐身模式或另一个浏览器
   - 访问 `http://localhost:3001`
   - 使用相同账户登录

3. **观察第一个会话**：
   - 应立即收到警告对话框："您的账户在其他设备上登录，当前会话将被强制下线"
   - 同时显示警告消息："检测到账户在其他地方登录，即将自动退出..."
   - 点击"我知道了"后自动跳转到登录页
   - 登录页显示："您的账户在其他地方登录，已自动退出"

4. **检查第二个会话**：
   - 应正常登录成功
   - WebSocket状态为绿色

#### 3. WebSocket连接状态测试
1. **正常连接**：
   - 登录后WebSocket状态为绿色
   - 控制台日志显示连接成功

2. **断开重连测试**：
   - 暂停后端服务
   - 观察WebSocket状态变为红色
   - 重启后端服务
   - 观察是否自动重连（状态变绿色）

### 预期结果

#### 正常情况
- ✅ 登录成功后WebSocket自动连接
- ✅ 状态指示器显示绿色（已连接）
- ✅ 多地登录时实时收到通知
- ✅ 强制下线后自动跳转登录页
- ✅ 网络断开后自动重连

#### 异常处理
- ✅ 网络错误时显示重连提示
- ✅ 认证失败时显示错误消息
- ✅ 连接断开时状态指示器变红色

### 调试信息

#### 浏览器控制台日志
```
🔌 正在连接WebSocket...
✅ WebSocket连接已建立
🔐 已发送WebSocket认证消息
✅ WebSocket认证成功: WebSocket认证成功
📨 收到WebSocket消息: {type: "force_logout", message: "您的账户在其他地方登录，当前会话将被强制下线", timestamp: 1703123456789}
🚨 收到强制登出通知: 您的账户在其他地方登录，当前会话将被强制下线
🚪 执行强制登出...
🔌 主动断开WebSocket连接
✅ 强制登出完成
```

#### 后端控制台日志
```
WebSocket连接建立: session-id-123
用户 admin 的WebSocket会话已认证
已通过WebSocket通知用户 admin 在其他地方登录
已通知用户 admin 账户在其他地方登录
用户 admin 的WebSocket连接已关闭
```

### 故障排除

#### 1. WebSocket无法连接
- 检查后端是否启动
- 检查防火墙设置
- 确认端口8080是否被占用

#### 2. 收不到强制下线通知
- 检查Redis服务是否运行
- 确认两个会话使用相同用户名
- 查看浏览器控制台错误信息

#### 3. 自动重连失败
- 检查网络连接
- 确认最大重连次数设置
- 查看WebSocket连接状态

### 性能考虑

1. **连接数限制**：每用户只保持一个WebSocket连接
2. **内存管理**：会话映射会在连接关闭时自动清理
3. **重连策略**：指数退避重连，最多5次尝试
4. **消息处理**：异步处理，不阻塞主线程

### 安全考虑

1. **认证机制**：WebSocket连接需要JWT token认证
2. **跨域控制**：生产环境需配置具体域名
3. **连接管理**：自动清理无效连接
4. **错误处理**：避免敏感信息泄露

## 总结

WebSocket实时通知功能已成功集成到登录安全系统中，能够实时通知用户多地登录情况，提升了系统的安全性和用户体验。 