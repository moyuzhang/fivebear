import{x as e,aB as a,aA as s,r,X as o,h as l,ag as n,y as i,z as t,A as u,P as d,H as c,L as g,M as m,a4 as p,u as f}from"./vue-vendor.C3rdx7ZB.js";import{r as v,u as h,_ as w}from"./index.Cjh-Y3mq.js";import{E as y,D as b}from"./element-plus.BDp-1BTq.js";import"./utils.3cDF09Hu.js";const _=e=>v.get("/auth/security/lock-status",{params:{username:e}}),x={class:"login-container"},k={class:"login-box"},q=w(e({__name:"Login",setup(e){const v=a(),w=s(),q=h(),V=r(),L=o({username:"",password:""}),j=o({username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:2,max:20,message:"用户名长度在 2 到 20 个字符",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:6,max:20,message:"密码长度在 6 到 20 个字符",trigger:"blur"}]}),z=r(!1),I=async()=>{var e;if(!V.value)return;if(await V.value.validate().catch((()=>!1))){if(L.username.trim())try{const a=await _(L.username.trim());if(null==(e=a.data)?void 0:e.isLocked){const e=a.data.remainingMinutes||0;return void y.warning(`账户已被锁定，请${e}分钟后再试`)}}catch(a){console.error("检查锁定状态失败:",a)}z.value=!0;try{console.log("🔐 开始登录..."),await q.login(L),console.log("✅ 登录成功"),y.success("登录成功");const e=w.query.redirect||"/dashboard";console.log("🔀 跳转到:",e),await v.push(e)}catch(a){console.error("❌ 登录失败:",a)}finally{z.value=!1}}};return l((async()=>{console.log("📄 登录页面挂载");if("forced_logout"===w.query.message&&y.warning("您的账户在其他地方登录，已自动退出"),q.isLoggedIn&&q.userInfo){console.log("👤 用户已登录，准备跳转");const e=w.query.redirect||"/dashboard";return console.log("🔀 跳转到:",e),void(await v.push(e))}if(q.token&&!q.userInfo){console.log("🔄 检测到token，尝试恢复登录状态...");if(await q.initUser()){const e=w.query.redirect||"/dashboard";console.log("🔀 状态恢复成功，跳转到:",e),await v.push(e)}}})),(e,a)=>{const s=n("el-input"),r=n("el-form-item"),o=n("el-button");return t(),i("div",x,[u("div",k,[a[2]||(a[2]=u("div",{class:"login-header"},[u("div",{class:"logo"},"🐻"),u("h2",null,"FiveBear 系统登录")],-1)),d(f(b),{ref_key:"loginFormRef",ref:V,model:L,rules:j,class:"login-form",onKeyup:p(I,["enter"])},{default:c((()=>[d(r,{prop:"username"},{default:c((()=>[d(s,{modelValue:L.username,"onUpdate:modelValue":a[0]||(a[0]=e=>L.username=e),placeholder:"请输入用户名","prefix-icon":"User",size:"large",clearable:""},null,8,["modelValue"])])),_:1}),d(r,{prop:"password"},{default:c((()=>[d(s,{modelValue:L.password,"onUpdate:modelValue":a[1]||(a[1]=e=>L.password=e),type:"password",placeholder:"请输入密码","prefix-icon":"Lock",size:"large","show-password":"",clearable:""},null,8,["modelValue"])])),_:1}),d(r,null,{default:c((()=>[d(o,{type:"primary",size:"large",loading:z.value,class:"login-btn",onClick:I},{default:c((()=>[g(m(z.value?"登录中...":"登录"),1)])),_:1},8,["loading"])])),_:1})])),_:1},8,["model","rules"]),a[3]||(a[3]=u("div",{class:"login-footer"},[u("p",null,"© 2024 FiveBear System. All rights reserved.")],-1))])])}}}),[["__scopeId","data-v-8c0dc6d8"]]);export{q as default};
