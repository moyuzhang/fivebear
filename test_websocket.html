<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocketæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .disconnected { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message { background-color: #f8f9fa; padding: 10px; margin: 5px 0; border-left: 4px solid #007bff; }
        .error { background-color: #f8d7da; padding: 10px; margin: 5px 0; border-left: 4px solid #dc3545; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input { padding: 8px; margin: 5px; width: 300px; }
        .controls { margin: 20px 0; }
        #messages { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; }
    </style>
</head>
<body>
    <h1>WebSocketè¿æ¥æµ‹è¯•</h1>
    
    <div class="controls">
        <input type="text" id="tokenInput" placeholder="è¯·è¾“å…¥JWT Token" />
        <button onclick="connect()">è¿æ¥</button>
        <button onclick="disconnect()">æ–­å¼€</button>
        <button onclick="sendPing()">å‘é€å¿ƒè·³</button>
        <button onclick="clearMessages()">æ¸…ç©ºæ¶ˆæ¯</button>
    </div>
    
    <div id="status" class="status disconnected">æœªè¿æ¥</div>
    
    <div id="messages"></div>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script>
        let socket = null;
        let token = '';

        function updateStatus(message, isConnected) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status ' + (isConnected ? 'connected' : 'disconnected');
        }

        function addMessage(content, isError = false) {
            const messagesEl = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = isError ? 'error' : 'message';
            messageEl.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${content}`;
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function connect() {
            token = document.getElementById('tokenInput').value.trim();
            if (!token) {
                alert('è¯·è¾“å…¥JWT Token');
                return;
            }

            if (socket) {
                socket.close();
            }

            try {
                const url = `http://localhost:8080/ws?token=${encodeURIComponent(token)}`;
                socket = new SockJS(url);

                socket.onopen = function() {
                    updateStatus('å·²è¿æ¥', true);
                    addMessage('WebSocketè¿æ¥æˆåŠŸ');
                };

                socket.onmessage = function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        addMessage(`æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(message, null, 2)}`);
                        
                        // ç‰¹æ®Šå¤„ç†å¼ºåˆ¶ç™»å‡ºæ¶ˆæ¯
                        if (message.type === 'FORCE_LOGOUT') {
                            addMessage(`<strong style="color: red;">æ”¶åˆ°å¼ºåˆ¶ç™»å‡ºé€šçŸ¥: ${message.message}</strong>`);
                            alert('ğŸš« å¼ºåˆ¶ç™»å‡ºé€šçŸ¥: ' + message.message);
                        }
                    } catch (e) {
                        addMessage(`æ”¶åˆ°éJSONæ¶ˆæ¯: ${event.data}`);
                    }
                };

                socket.onerror = function(error) {
                    updateStatus('è¿æ¥é”™è¯¯', false);
                    addMessage(`WebSocketé”™è¯¯: ${error}`, true);
                };

                socket.onclose = function(event) {
                    updateStatus('è¿æ¥å·²å…³é—­', false);
                    addMessage(`WebSocketè¿æ¥å…³é—­: Code=${event.code}, Reason=${event.reason}`);
                };

            } catch (error) {
                updateStatus('è¿æ¥å¤±è´¥', false);
                addMessage(`è¿æ¥å¤±è´¥: ${error.message}`, true);
            }
        }

        function disconnect() {
            if (socket) {
                socket.close();
                socket = null;
            }
        }

        function sendPing() {
            if (socket && socket.readyState === SockJS.OPEN) {
                const message = {
                    type: "login_notification",
                    action: "ping",
                    data: {}
                };
                socket.send(JSON.stringify(message));
                addMessage('å‘é€å¿ƒè·³æ¶ˆæ¯');
            } else {
                addMessage('WebSocketæœªè¿æ¥', true);
            }
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        // é¡µé¢åŠ è½½æ—¶çš„è¯´æ˜
        window.onload = function() {
            addMessage('WebSocketæµ‹è¯•é¡µé¢å·²åŠ è½½');
            addMessage('1. è¯·å…ˆåœ¨æµè§ˆå™¨ä¸­ç™»å½•ç³»ç»Ÿè·å–JWT Token');
            addMessage('2. å°†Tokenç²˜è´´åˆ°è¾“å…¥æ¡†ä¸­');
            addMessage('3. ç‚¹å‡»è¿æ¥æŒ‰é’®å»ºç«‹WebSocketè¿æ¥');
            addMessage('4. åœ¨å¦ä¸€ä¸ªæµè§ˆå™¨æˆ–æ ‡ç­¾é¡µä¸­ç”¨ç›¸åŒç”¨æˆ·åç™»å½•ï¼Œåº”è¯¥ä¼šæ”¶åˆ°å¼ºåˆ¶ç™»å‡ºé€šçŸ¥');
        };
    </script>
</body>
</html> 