# 多地登录限制功能测试指南

## 🎯 测试目标

验证系统的多地登录限制功能，确保：
- 同一用户只能在一个地方保持登录状态
- 新登录会强制下线之前的会话
- 被强制下线的会话在下次请求时会自动跳转到登录页
- Redis正确管理用户会话状态

## 🛠️ 测试环境要求

### 服务状态检查
- ✅ **前端**: http://localhost:3001
- ✅ **后端**: http://localhost:8080  
- ✅ **Redis**: localhost:6379 (确保Redis服务正在运行)

### 测试工具
- **浏览器1**: Chrome (或主浏览器)
- **浏览器2**: Firefox/Edge (或Chrome无痕模式)
- **测试账户**: admin / Aa147258

## 📝 详细测试步骤

### 步骤1: 环境准备

1. **启动Redis服务** (如果尚未启动):
   ```bash
   # Windows
   redis-server
   
   # 或者检查Redis是否运行
   redis-cli ping
   ```

2. **清理Redis中的测试数据**:
   ```bash
   redis-cli FLUSHDB
   ```

3. **确保前后端服务运行正常**:
   - 前端: http://localhost:3001
   - 后端: http://localhost:8080

### 步骤2: 第一次登录 (浏览器1)

1. **打开浏览器1** (如Chrome)
2. **访问**: `http://localhost:3001`
3. **登录**:
   - 用户名: `admin`
   - 密码: `Aa147258`
4. **验证登录成功**:
   - 跳转到Dashboard页面
   - 显示用户信息和导航栏
   - 能正常访问其他页面

**预期结果**:
- ✅ 登录成功，正常显示用户界面
- ✅ Console显示: "✅ 登录成功，用户信息: {...}"
- ✅ Redis中存储了用户会话信息

**Redis数据检查**:
```bash
# 检查Redis中的用户会话
redis-cli KEYS "user_session:admin"
redis-cli GET "user_session:admin"
```

### 步骤3: 第二次登录 (浏览器2) - 触发强制下线

1. **打开浏览器2** (如Firefox或Chrome无痕模式)
2. **访问**: `http://localhost:3001`
3. **使用相同账户登录**:
   - 用户名: `admin`
   - 密码: `Aa147258`
4. **观察登录过程**

**预期结果**:
- ✅ 浏览器2成功登录
- ✅ 显示用户界面
- ✅ Console显示登录成功信息
- ✅ Redis中的会话信息更新为新的token

**后端日志应该显示**:
```
强制下线用户其他会话: admin
用户 admin 登录成功，新token: xxx
```

### 步骤4: 验证浏览器1被强制下线

**切换回浏览器1**，执行以下操作：

1. **刷新页面** 或 **尝试访问其他页面**
2. **点击导航菜单** 或 **进行任何需要认证的操作**

**预期结果**:
- ❌ 自动跳转到登录页面
- ❌ 显示"登录已过期，请重新登录"提示
- ❌ 用户信息和导航栏消失
- ✅ Console显示: "🔒 Token已过期或无效"

**URL变化**:
```
从: http://localhost:3001/dashboard
到: http://localhost:3001/login?redirect=%2Fdashboard
```

### 步骤5: 验证浏览器2仍然有效

**切换到浏览器2**：

1. **刷新页面**
2. **访问不同的页面** (admin、report、shipment)
3. **执行用户操作**

**预期结果**:
- ✅ 页面正常显示
- ✅ 所有功能正常工作
- ✅ 用户状态保持登录

### 步骤6: 测试第三次登录 (移动端模拟)

**再次在浏览器1中登录**：

1. **在浏览器1的登录页面重新登录**
2. **使用相同的admin账户**

**预期结果**:
- ✅ 浏览器1成功登录
- ❌ 浏览器2在下次操作时会被强制下线

### 步骤7: API请求级别测试 (高级测试)

使用浏览器开发者工具观察网络请求：

1. **在有效会话中**:
   - API请求正常返回200
   - 携带有效的Authorization头

2. **在被强制下线的会话中**:
   - API请求返回401 Unauthorized
   - 响应消息包含"Token无效"或类似信息

## 🔍 Redis数据验证

在测试过程中，可以使用以下命令检查Redis状态：

```bash
# 查看所有用户会话
redis-cli KEYS "user_session:*"

# 查看特定用户的会话
redis-cli GET "user_session:admin"

# 查看强制下线的token列表
redis-cli SMEMBERS "forced_offline_tokens:admin"

# 查看所有Redis数据
redis-cli KEYS "*"
```

**预期的Redis数据结构**:
```
user_session:admin -> "最新的token值"
forced_offline_tokens:admin -> ["被强制下线的token1", "被强制下线的token2"]
```

## 🐛 常见问题排查

### 问题1: 第二次登录没有强制下线第一次登录

**可能原因**:
- Redis服务未启动
- 后端LoginSecurityService配置错误
- Token生成问题

**检查方法**:
```bash
# 检查Redis连接
redis-cli ping

# 查看后端日志
# 应该显示"强制下线用户其他会话"消息
```

### 问题2: 强制下线后仍能正常访问

**可能原因**:
- AuthInterceptor未正确检查强制下线状态
- Token验证逻辑错误

**检查方法**:
- 查看浏览器Network面板的API请求
- 检查返回状态码是否为401

### 问题3: Redis数据异常

**可能原因**:
- Redis序列化配置问题
- 数据过期时间设置错误

**解决方法**:
```bash
# 清理Redis数据重新测试
redis-cli FLUSHDB
```

## 📊 测试记录表

| 测试项目 | 预期结果 | 实际结果 | 状态 |
|---------|---------|---------|------|
| 第一次登录成功 | ✅ 正常登录 |  | ⏳ |
| Redis存储会话 | ✅ 数据正确 |  | ⏳ |
| 第二次登录成功 | ✅ 正常登录 |  | ⏳ |
| 第一次会话强制下线 | ❌ 跳转登录页 |  | ⏳ |
| 第二次会话保持有效 | ✅ 正常使用 |  | ⏳ |
| API请求401响应 | ✅ 正确响应 |  | ⏳ |
| Redis数据更新 | ✅ 数据正确 |  | ⏳ |

## 🎯 测试成功标准

**所有以下条件都满足时，测试通过**:

1. ✅ 第一次登录正常工作
2. ✅ 第二次登录会强制下线第一次登录
3. ✅ 被强制下线的会话在操作时自动跳转到登录页
4. ✅ 最新的登录会话保持有效
5. ✅ Redis正确存储和更新会话数据
6. ✅ API请求返回正确的401状态码
7. ✅ 用户体验流畅，提示信息清晰

---

**开始测试时，请确保按照步骤顺序执行，并观察每一步的结果！** 🚀 